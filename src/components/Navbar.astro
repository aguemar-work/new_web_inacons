---
// src/components/Navbar.astro (Desktop only)
import { navItems } from "../data/navigation";
const currentPath = Astro.url.pathname;

const isActive = (href: string): boolean => {
  if (href === "/") return currentPath === "/";
  return currentPath === href || currentPath.startsWith(`${href}/`);
};
---

<header 
  id="main-header" 
  class="header" 
  role="banner"
  data-header
>
  <div class="container nav-container">
    <!-- Logo -->
    <a href="/" class="logo">
      <img
        src="/images/logo_inacons_white.svg"
        alt="Inacons - Inicio"
        width="150"
        height="50"
        fetchpriority="high"
        class="logo-light"
        loading="eager"
      />
      <img
        src="/images/logo_inacons_dark.svg"
        alt="Inacons - Inicio"
        width="150"
        height="50"
        class="logo-dark"
        loading="eager"
        aria-hidden="true"
      />
    </a>

    <!-- Navegación -->
    <nav class="desktop-nav" aria-label="Navegación principal">
      <ul>
        {navItems.map((item) => (
          <li class={item.children ? "has-dropdown" : ""}>
            {item.children ? (
              <>
                <a
                  href={item.href}
                  class={`dropdown-trigger ${isActive(item.href) ? "active" : ""}`}
                  aria-haspopup="true"
                  aria-expanded="false"
                  data-dropdown-trigger
                >
                  {item.label}
                </a>
                <!-- DROPDOWN (Single Column) -->
                <ul
                  class="dropdown"
                  role="menu"
                  aria-label={`Submenú de ${item.label}`}
                >
                  {item.children.map((child) => (
                    <li role="none">
                      <a
                        href={child.href}
                        role="menuitem"
                        class={isActive(child.href) ? "active" : ""}
                        aria-current={isActive(child.href) ? "page" : undefined}
                      >
                        {child.label}
                      </a>
                    </li>
                  ))}
                </ul>
              </>
            ) : (
              <a
                href={item.href}
                class={isActive(item.href) ? "active" : ""}
                aria-current={isActive(item.href) ? "page" : undefined}
              >
                {item.label}
              </a>
            )}
          </li>
        ))}
      </ul>
    </nav>
  </div>
</header>

<script>
  (() => {
    'use strict';
    
    const header = document.getElementById('main-header');
    const topbar = document.getElementById('topbar');
    
    if (!header) return;
    
    let lastScrollY = window.scrollY;
    let ticking = false;
    
    const updateHeader = () => {
      const currentScrollY = window.scrollY;
      const isScrollingDown = currentScrollY > lastScrollY;
      const scrollDelta = Math.abs(currentScrollY - lastScrollY);
      
      // Regla 3: Top del documento (Estado Inicial)
      if (currentScrollY <= 0) {
        // Mostrar ambos
        header.classList.remove('header--hidden', 'header--sticky');
        header.classList.add('header--top');
        topbar?.classList.remove('topbar--hidden');
      }
      // Regla 1: Scroll Down (Ocultar todo)
      else if (isScrollingDown && currentScrollY > 10) {
        header.classList.remove('header--top');
        header.classList.add('header--hidden');
        header.classList.remove('header--sticky');
        topbar?.classList.add('topbar--hidden');
      }
      // Regla 2: Scroll Up (Mostrar solo Navbar Sticky)
      else if (!isScrollingDown && scrollDelta > 5) {
        header.classList.remove('header--top', 'header--hidden');
        header.classList.add('header--sticky');
        
        // Mantener TopBar oculto si no estamos en el top
        if (currentScrollY > 0) {
          topbar?.classList.add('topbar--hidden');
        }
      }
      
      lastScrollY = currentScrollY;
      ticking = false;
    };
    
    const handleScroll = () => {
      if (!ticking) {
        requestAnimationFrame(updateHeader);
        ticking = true;
      }
    };
    
    window.addEventListener('scroll', handleScroll, { passive: true });
    // Inicializar estado
    updateHeader();
    
  })();
</script>

<style>
  /* ===== BASE ===== */
  @media (max-width: 1023px) {
    .header {
      display: none !important;
    }
  }
  
  .header {
    position: fixed;
    top: 40px; /* Debajo del TopBar */
    left: 0;
    width: 100%;
    z-index: 1000;
    transition:
      transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform;
  }
  
  .nav-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 80px;
  }
  
  /* ===== LOGO ===== */
  .logo {
    display: block;
    position: relative;
  }
  
  .logo img {
    height: 50px;
    width: auto;
    transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    object-fit: contain;
  }
  
  .logo-dark {
    position: absolute;
    top: 0;
    left: 0;
    opacity: 0;
  }
  
  /* ===== STATES ===== */
  
  /* 1. Initial State (Transparent, White Text) */
  .header--top {
    background-color: transparent;
    color: white;
    box-shadow: none;
    transform: translateY(0);
  }
  
  /* 2. Sticky State (White BG, Dark Text, Moved to Top) */
  .header--sticky {
    background-color: rgba(255, 255, 255, 0.98);
    backdrop-filter: saturate(180%) blur(20px);
    -webkit-backdrop-filter: saturate(180%) blur(20px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    color: #1a1a1a;
    padding: 0.5rem 0;
    transform: translateY(-40px); /* Move up to cover TopBar space */
  }
  
  .header--sticky .logo-light {
    opacity: 0;
  }
  
  .header--sticky .logo-dark {
    opacity: 1;
  }
  
  .header--sticky .desktop-nav a {
    color: #1a1a1a;
  }
  
  .header--sticky .desktop-nav a:hover,
  .header--sticky .desktop-nav a.active {
    color: var(--color-primary, #0066cc);
  }

  /* 3. Hidden State (Scroll Down) */
  .header--hidden {
    transform: translateY(-200%); /* Move completely off screen */
    /* Maintain styles of sticky/scrolled so it doesn't flash when appearing */
    background-color: rgba(255, 255, 255, 0.98);
    color: #1a1a1a;
  }
  
  /* ===== NAVIGATION ===== */
  .desktop-nav > ul {
    display: flex;
    gap: 2.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }
  
  .desktop-nav a {
    text-decoration: none;
    font-weight: 500;
    font-size: 1rem;
    transition: color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: inherit;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    position: relative;
    padding: 0.5rem 0;
  }
  
  .desktop-nav a:hover,
  .desktop-nav a.active {
    color: var(--color-primary, #0066cc);
  }
  
  .desktop-nav a::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background-color: var(--color-primary, #0066cc);
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .desktop-nav a:hover::after,
  .desktop-nav a.active::after {
    width: 100%;
  }
  
  /* ===== DROPDOWN SYSTEM ===== */
  .has-dropdown {
    position: relative;
  }
  
  .dropdown-arrow {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .has-dropdown:hover .dropdown-arrow {
    transform: rotate(180deg);
  }
  
  /* Dropdown Container */
  .dropdown {
    position: absolute;
    top: 150%;
    left: 0;
    min-width: 240px; /* Single column width */
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    
    /* Animation Initial State */
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);

    transition:
      opacity 0.3s ease,
      transform 0.3s ease,
      visibility 0s linear 0.3s;
  }
  
  /* Bridge for hover area */
  .has-dropdown::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    height: 2.5rem;
  }
  
  /* Hover State */
  .has-dropdown:hover .dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    transition-delay: 0s; /* Immediate entrance */
  }
  
  /* Dropdown Items */
  .dropdown li {
    display: block;
  }
  
  .dropdown a {
    padding: 1.5rem;
    color: #333;
    white-space: nowrap;
    font-size: var(--text-bases);
    display: block;
    text-decoration: none;
    transition: 
      color 0.2s ease,
      background-color 0.2s ease;
  }
  
  .dropdown a:hover,
  .dropdown a.active {
    background-color: rgba(0, 102, 204, 0.08);
    color: var(--color-primary, #0066cc);
  }
  
  .dropdown a::after {
    display: none;
  }

  .dropdown::before {
    content: '';
    position: absolute;
    top: -6px;
    left: 20px;
    width: 12px;
    height: 12px;
    background: white;
    transform: rotate(45deg);
    box-shadow: -2px -2px 5px rgba(0, 0, 0, 0.05);
    z-index: -1;
  }
  
</style>